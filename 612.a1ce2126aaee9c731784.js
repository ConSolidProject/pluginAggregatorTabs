(self.webpackChunktabs=self.webpackChunktabs||[]).push([[612],{88041:(e,t,r)=>{"use strict";r.r(t),r.d(t,{CompactEncrypt:()=>Ae,CompactSign:()=>We,EmbeddedJWK:()=>Pe,EncryptJWT:()=>Qe,FlattenedEncrypt:()=>be,FlattenedSign:()=>Ne,GeneralSign:()=>$e,JOSEAlgNotAllowed:()=>o,JOSEError:()=>n,JOSENotSupported:()=>s,JWEDecryptionFailed:()=>a,JWEInvalid:()=>c,JWKInvalid:()=>l,JWKSInvalid:()=>p,JWKSMultipleMatchingKeys:()=>y,JWKSNoMatchingKey:()=>h,JWSInvalid:()=>d,JWSSignatureVerificationFailed:()=>f,JWTClaimValidationFailed:()=>i,JWTExpired:()=>g,JWTInvalid:()=>u,SignJWT:()=>Ze,UnsecuredJWT:()=>et,base64UrlDecode:()=>nt,base64UrlEncode:()=>rt,calculateThumbprint:()=>Te,compactDecrypt:()=>Se,compactVerify:()=>je,createRemoteJWKSet:()=>Ce,decodeProtectedHeader:()=>it,flattenedDecrypt:()=>we,flattenedVerify:()=>Je,fromKeyLike:()=>me,generalDecrypt:()=>Ie,generalVerify:()=>Le,generateKeyPair:()=>st,generateSecret:()=>at,jwtDecrypt:()=>Xe,jwtVerify:()=>tt,parseJwk:()=>ae,random:()=>ct});class n extends Error{constructor(e){super(e),this.code=n.code,this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}n.code="ERR_JOSE_GENERIC";class i extends n{constructor(e,t="unspecified",r="unspecified"){super(e),this.code=i.code,this.claim=t,this.reason=r}}i.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class o extends n{constructor(){super(...arguments),this.code=o.code}}o.code="ERR_JOSE_ALG_NOT_ALLOWED";class s extends n{constructor(){super(...arguments),this.code=s.code}}s.code="ERR_JOSE_NOT_SUPPORTED";class a extends n{constructor(){super(...arguments),this.code=a.code,this.message="decryption operation failed"}}a.code="ERR_JWE_DECRYPTION_FAILED";class c extends n{constructor(){super(...arguments),this.code=c.code}}c.code="ERR_JWE_INVALID";class d extends n{constructor(){super(...arguments),this.code=d.code}}d.code="ERR_JWS_INVALID";class u extends n{constructor(){super(...arguments),this.code=u.code}}u.code="ERR_JWT_INVALID";class l extends n{constructor(){super(...arguments),this.code=l.code}}l.code="ERR_JWK_INVALID";class p extends n{constructor(){super(...arguments),this.code=p.code}}p.code="ERR_JWKS_INVALID";class h extends n{constructor(){super(...arguments),this.code=h.code,this.message="no applicable key found in the JSON Web Key Set"}}h.code="ERR_JWKS_NO_MATCHING_KEY";class y extends n{constructor(){super(...arguments),this.code=y.code,this.message="multiple matching keys found in the JSON Web Key Set"}}y.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class f extends n{constructor(){super(...arguments),this.code=f.code,this.message="signature verification failed"}}f.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";class g extends i{constructor(){super(...arguments),this.code=g.code}}g.code="ERR_JWT_EXPIRED";const w=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0};function S(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}const m=new TextEncoder,E=new TextDecoder,_=2**32;function v(...e){const t=e.reduce(((e,{length:t})=>e+t),0),r=new Uint8Array(t);let n=0;return e.forEach((e=>{r.set(e,n),n+=e.length})),r}function b(e,t){return v(m.encode(e),new Uint8Array([0]),t)}function A(e,t,r){if(t<0||t>=_)throw new RangeError(`value must be >= 0 and <= 4294967295. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function I(e){const t=Math.floor(e/_),r=e%_,n=new Uint8Array(8);return A(n,t,0),A(n,r,4),n}function P(e){const t=new Uint8Array(4);return A(t,e),t}function k(e){return v(P(e.length),e)}var T=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;throw new Error("unable to locate global object")}();const R=e=>{let t=e;"string"==typeof t&&(t=m.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return T.btoa(r.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},U=e=>{let t=e;t instanceof Uint8Array&&(t=E.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return new Uint8Array(T.atob(t).split("").map((e=>e.charCodeAt(0))))}catch(e){throw new TypeError("The input to be decoded is not correctly encoded.")}},C=new Map([["A128CBC-HS256",128],["A128GCM",96],["A128GCMKW",96],["A192CBC-HS384",128],["A192GCM",96],["A192GCMKW",96],["A256CBC-HS512",128],["A256GCM",96],["A256GCMKW",96]]),H=e=>t=>{const r=C.get(t);if(!r)throw new s(`Unsupported JWE Algorithm: ${t}`);return e(new Uint8Array(r>>3))},O=(e,t)=>{if(t.length<<3!==C.get(e))throw new c("Invalid Initialization Vector length")};var K=T.crypto;function N(e){return void 0!==T.CryptoKey&&null!=e&&e instanceof T.CryptoKey}const W=(e,t)=>{let r;switch(e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":if(r=parseInt(e.substr(-3),10),!(t instanceof Uint8Array))throw new TypeError(`${e} content encryption requires Uint8Array as key input`);break;case"A128GCM":case"A192GCM":case"A256GCM":r=parseInt(e.substr(1,3),10);break;default:throw new s(`Content Encryption Algorithm ${e} is not supported either by JOSE or your javascript runtime`)}if(t instanceof Uint8Array){if(t.length<<3!==r)throw new c("Invalid Content Encryption Key length")}else{if(!N(t))throw new TypeError("Invalid Content Encryption Key type");{const{length:e}=t.algorithm;if(e!==r)throw new c("Invalid Content Encryption Key length")}}};var D=(e,...t)=>{let r="Key must be ";if(t.length>2){const e=t.pop();r+=`one of type ${t.join(", ")}, or ${e}.`}else 2===t.length?r+=`one of type ${t[0]} or ${t[1]}.`:r+=`of type ${t[0]}.`;return null==e?r+=` Received ${e}`:"function"==typeof e&&e.name?r+=` Received function ${e.name}`:"object"==typeof e&&null!=e&&e.constructor&&e.constructor.name&&(r+=` Received an instance of ${e.constructor.name}`),r};const M=async(e,t,r,n,i,o)=>{if(!(N(t)||t instanceof Uint8Array))throw new TypeError(D(t,"CryptoKey","Uint8Array"));switch(W(e,t),O(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return async function(e,t,r,n,i,o){const s=parseInt(e.substr(1,3),10),c=await K.subtle.importKey("raw",t.subarray(s>>3),"AES-CBC",!1,["decrypt"]),d=await K.subtle.importKey("raw",t.subarray(0,s>>3),{hash:{name:"SHA-"+(s<<1)},name:"HMAC"},!1,["sign"]),u=v(o,n,r,I(o.length<<3)),l=new Uint8Array((await K.subtle.sign("HMAC",d,u)).slice(0,s>>3));let p,h;try{p=((e,t)=>{if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");if(e.length!==t.length)throw new TypeError("Input buffers must have the same length");const r=e.length;let n=0,i=-1;for(;++i<r;)n|=e[i]^t[i];return 0===n})(i,l)}catch(e){}if(!p)throw new a;try{h=new Uint8Array(await K.subtle.decrypt({iv:n,name:"AES-CBC"},c,r))}catch(e){}if(!h)throw new a;return h}(e,t,r,n,i,o);case"A128GCM":case"A192GCM":case"A256GCM":return async function(e,t,r,n,i){const o=e instanceof Uint8Array?await K.subtle.importKey("raw",e,"AES-GCM",!1,["decrypt"]):e;try{return new Uint8Array(await K.subtle.decrypt({additionalData:i,iv:r,name:"AES-GCM",tagLength:128},o,v(t,n)))}catch(e){throw new a}}(t,r,n,i,o);default:throw new s("unsupported JWE Content Encryption Algorithm")}},J=async()=>{throw new s('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime. You need to use the `inflateRaw` decrypt option to provide Inflate Raw implementation, e.g. using the "pako" module.')},j=async()=>{throw new s('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime.')},F=[{hash:{name:"SHA-256"},name:"HMAC"},!0,["sign"]];function x(e,t){if(e.algorithm.length!==parseInt(t.substr(1,3),10))throw new TypeError(`invalid key size for alg: ${t}`)}function $(e,t){if(N(e))return e;if(e instanceof Uint8Array)return K.subtle.importKey("raw",e,"AES-KW",!0,[t]);throw new TypeError(D(e,"CryptoKey","Uint8Array"))}const L=async(e,t,r)=>{const n=await $(t,"wrapKey");x(n,e);const i=await K.subtle.importKey("raw",r,...F);return new Uint8Array(await K.subtle.wrapKey("raw",i,n,"AES-KW"))},G=async(e,t,r)=>{const n=await $(t,"unwrapKey");x(n,e);const i=await K.subtle.unwrapKey("raw",r,n,"AES-KW",...F);return new Uint8Array(await K.subtle.exportKey("raw",i))},B=async(e,t)=>{const r=`SHA-${e.substr(-3)}`;return new Uint8Array(await K.subtle.digest(r,t))},V=async(e,t,r,n,i=new Uint8Array(0),o=new Uint8Array(0))=>{if(!N(e))throw new TypeError(D(e,"CryptoKey"));if(!N(t))throw new TypeError(D(t,"CryptoKey"));const s=v(k(m.encode(r)),k(i),k(o),P(n));if(!t.usages.includes("deriveBits"))throw new TypeError('ECDH-ES private key "usages" must include "deriveBits"');const a=new Uint8Array(await K.subtle.deriveBits({name:"ECDH",public:e},t,Math.ceil(parseInt(t.algorithm.namedCurve.substr(-3),10)/8)<<3));return async function(e,t,r,n){const i=Math.ceil((r>>3)/32);let o;for(let r=1;r<=i;r++){const i=new Uint8Array(4+t.length+n.length);i.set(P(r)),i.set(t,4),i.set(n,4+t.length),o=o?v(o,await e("sha256",i)):await e("sha256",i)}return o=o.slice(0,r>>3),o}(B,a,n,s)},z=e=>{if(!N(e))throw new TypeError(D(e,"CryptoKey"));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)},q=K.getRandomValues.bind(K);function X(e){if(!(e instanceof Uint8Array)||e.length<8)throw new c("PBES2 Salt Input must be 8 or more octets")}function Y(e){if(e instanceof Uint8Array)return K.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if(N(e))return e;throw new TypeError(D(e,"CryptoKey","Uint8Array"))}const Q=async(e,t,r,n=Math.floor(2049*Math.random())+2048,i=q(new Uint8Array(16)))=>{X(i);const o=b(e,i),s=parseInt(e.substr(13,3),10),a={hash:{name:`SHA-${e.substr(8,3)}`},iterations:n,name:"PBKDF2",salt:o},c={length:s,name:"AES-KW"},d=await Y(t);let u;if(d.usages.includes("deriveBits"))u=new Uint8Array(await K.subtle.deriveBits(a,d,s));else{if(!d.usages.includes("deriveKey"))throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"');u=await K.subtle.deriveKey(a,d,c,!1,["wrapKey"])}return{encryptedKey:await L(e.substr(-6),u,r),p2c:n,p2s:R(i)}},Z=async(e,t,r,n,i)=>{X(i);const o=b(e,i),s=parseInt(e.substr(13,3),10),a={hash:{name:`SHA-${e.substr(8,3)}`},iterations:n,name:"PBKDF2",salt:o},c={length:s,name:"AES-KW"},d=await Y(t);let u;if(d.usages.includes("deriveBits"))u=new Uint8Array(await K.subtle.deriveBits(a,d,s));else{if(!d.usages.includes("deriveKey"))throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"');u=await K.subtle.deriveKey(a,d,c,!1,["unwrapKey"])}return G(e.substr(-6),u,r)};function ee(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new s(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}var te=(e,t)=>{if(e.startsWith("HS")){const r=parseInt(e.substr(-3),10),{length:n}=t.algorithm;if("number"!=typeof n||n<r)throw new TypeError(`${e} requires symmetric keys to be ${r} bits or larger`)}if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};const re=async(e,t,r,n,i)=>{if(!(N(r)||r instanceof Uint8Array))throw new TypeError(D(r,"CryptoKey","Uint8Array"));switch(W(e,r),O(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return async function(e,t,r,n,i){const o=parseInt(e.substr(1,3),10),s=await K.subtle.importKey("raw",r.subarray(o>>3),"AES-CBC",!1,["encrypt"]),a=await K.subtle.importKey("raw",r.subarray(0,o>>3),{hash:{name:"SHA-"+(o<<1)},name:"HMAC"},!1,["sign"]),c=new Uint8Array(await K.subtle.encrypt({iv:n,name:"AES-CBC"},s,t)),d=v(i,n,c,I(i.length<<3));return{ciphertext:c,tag:new Uint8Array((await K.subtle.sign("HMAC",a,d)).slice(0,o>>3))}}(e,t,r,n,i);case"A128GCM":case"A192GCM":case"A256GCM":return async function(e,t,r,n){const i=t instanceof Uint8Array?await K.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt"]):t,o=new Uint8Array(await K.subtle.encrypt({additionalData:n,iv:r,name:"AES-GCM",tagLength:128},i,e)),s=o.slice(-16);return{ciphertext:o.slice(0,-16),tag:s}}(t,r,n,i);default:throw new s("unsupported JWE Content Encryption Algorithm")}},ne=H(q),ie=new Map([["A128CBC-HS256",256],["A128GCM",128],["A192CBC-HS384",384],["A192GCM",192],["A256CBC-HS512",512],["A256GCM",256]]),oe=e=>t=>{const r=ie.get(t);if(!r)throw new s(`Unsupported JWE Algorithm: ${t}`);return e(new Uint8Array(r>>3))},se=async e=>{var t,r;const{algorithm:n,keyUsages:i}=function(e){let t,r;switch(e.kty){case"oct":switch(e.alg){case"HS256":case"HS384":case"HS512":t={name:"HMAC",hash:{name:`SHA-${e.alg.substr(-3)}`}},r=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":throw new s(`${e.alg} keys cannot be imported as CryptoKey instances`);case"A128GCM":case"A192GCM":case"A256GCM":case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":t={name:"AES-GCM"},r=["encrypt","decrypt"];break;case"A128KW":case"A192KW":case"A256KW":t={name:"AES-KW"},r=["wrapKey","unwrapKey"];break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":t={name:"PBKDF2"},r=["deriveBits"];break;default:throw new s('unsupported or invalid JWK "alg" (Algorithm) Parameter value')}break;case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:{name:`SHA-${e.alg.substr(-3)}`}},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:{name:`SHA-${e.alg.substr(-3)}`}},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:{name:`SHA-${parseInt(e.alg.substr(-3),10)||1}`}},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new s('unsupported or invalid JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":case"ES384":case"ES512":t={name:"ECDSA",namedCurve:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new s('unsupported or invalid JWK "alg" (Algorithm) Parameter value')}break;default:throw new s('unsupported or invalid JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e);let o="jwk",a={...e};return delete a.alg,"PBKDF2"===n.name&&(o="raw",a=U(e.k)),K.subtle.importKey(o,a,n,null!==(t=e.ext)&&void 0!==t&&t,null!==(r=e.key_ops)&&void 0!==r?r:i)};async function ae(e,t,r){if(!S(e))throw new TypeError("JWK must be an object");if(t||(t=e.alg),"string"!=typeof t||!t)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');switch(e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return null!=r||(r=!0!==e.ext),r?se({...e,alg:t,ext:!1}):U(e.k);case"RSA":if(void 0!==e.oth)throw new s('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return se({...e,alg:t});default:throw new s('unsupported "kty" (Key Type) Parameter value')}}const ce=(e,t,r)=>{if(!(t instanceof Uint8Array||(null==t?void 0:t.type)))throw new TypeError(D(t,"KeyObject","CryptoKey","Uint8Array"));if(e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||e.match(/^A\d{3}(?:GCM)?KW$/)){if(t instanceof Uint8Array||"secret"===t.type)return;throw new TypeError('CryptoKey or KeyObject instances for symmetric algorithms must be of type "secret"')}if(t instanceof Uint8Array)throw new TypeError(D(t,"KeyObject","CryptoKey"));if("secret"===t.type)throw new TypeError('CryptoKey or KeyObject instances for asymmetric algorithms must not be of type "secret"');if("sign"===r&&"public"===t.type)throw new TypeError('CryptoKey or KeyObject instances for asymmetric algorithm signing must be of type "private"');if("decrypt"===r&&"public"===t.type)throw new TypeError('CryptoKey or KeyObject instances for asymmetric algorithm decryption must be of type "private"')};function de(e){if(!e)throw new c("JWE Encrypted Key missing")}function ue(e,t,r){if(void 0===e[t])throw new c(`JOSE Header ${r} (${t}) missing`)}function le(e,t,r,n,i){if(void 0!==i.crit&&void 0===n.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let o;o=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!o.has(t))throw new s(`Extension Header Parameter "${t}" is not recognized`);if(void 0===i[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(o.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)}const pe=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)},he=oe(q),ye=le.bind(void 0,c,new Map),fe=pe.bind(void 0,"keyManagementAlgorithms"),ge=pe.bind(void 0,"contentEncryptionAlgorithms");async function we(e,t,r){var n;if(!S(e))throw new c("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new c("JOSE Header missing");if("string"!=typeof e.iv)throw new c("JWE Initialization Vector missing or incorrect type");if("string"!=typeof e.ciphertext)throw new c("JWE Ciphertext missing or incorrect type");if("string"!=typeof e.tag)throw new c("JWE Authentication Tag missing or incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new c("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new c("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new c("JWE AAD incorrect type");if(void 0!==e.header&&!S(e.header))throw new c("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!S(e.unprotected))throw new c("JWE Per-Recipient Unprotected Header incorrect type");let i;if(e.protected){const t=U(e.protected);try{i=JSON.parse(E.decode(t))}catch(e){throw new c("JWE Protected Header is invalid")}}if(!w(i,e.header,e.unprotected))throw new c("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const a={...i,...e.header,...e.unprotected};if(ye(null==r?void 0:r.crit,i,a),void 0!==a.zip){if(!i||!i.zip)throw new c('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==a.zip)throw new s('unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:d,enc:u}=a;if("string"!=typeof d||!d)throw new c("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof u||!u)throw new c("missing JWE Encryption Algorithm (enc) in JWE Header");const l=r&&fe(r.keyManagementAlgorithms),p=r&&ge(r.contentEncryptionAlgorithms);if(l&&!l.has(d))throw new o('"alg" (Algorithm) Header Parameter not allowed');if(p&&!p.has(u))throw new o('"enc" (Encryption Algorithm) Header Parameter not allowed');let h,y;void 0!==e.encrypted_key&&(h=U(e.encrypted_key)),"function"==typeof t&&(t=await t(i,e));try{y=await async function(e,t,r,n){switch(ce(e,t,"decrypt"),e){case"dir":if(void 0!==r)throw new c("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new c("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(ue(n,"epk","Ephemeral Public Key"),!z(t))throw new s("ECDH-ES with the provided key is not allowed or not supported by your javascript runtime");const i=await ae(n.epk,e);let o,a;void 0!==n.apu&&(o=U(n.apu)),void 0!==n.apv&&(a=U(n.apv));const c=await V(i,t,"ECDH-ES"===e?n.enc:e,parseInt(e.substr(-5,3),10)||ie.get(n.enc),o,a);if("ECDH-ES"===e)return c;de(r);const d=e.substr(-6);return G(d,c,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return de(r),(async(e,t,r)=>{if(!N(t))throw new TypeError(D(t,"CryptoKey"));if(te(e,t),t.usages.includes("decrypt"))return new Uint8Array(await K.subtle.decrypt(ee(e),t,r));if(t.usages.includes("unwrapKey")){const n=await K.subtle.unwrapKey("raw",r,t,ee(e),...F);return new Uint8Array(await K.subtle.exportKey("raw",n))}throw new TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')})(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{de(r),ue(n,"p2c","PBES2 Count"),ue(n,"p2s","PBES2 Salt");const{p2c:i}=n,o=U(n.p2s);return Z(e,t,r,i,o)}case"A128KW":case"A192KW":case"A256KW":return de(r),G(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":return de(r),ue(n,"iv","Initialization Vector"),ue(n,"tag","Authentication Tag"),(async(e,t,r,n,i)=>{const o=e.substr(0,7);return M(o,t,r,n,i,new Uint8Array(0))})(e,t,r,U(n.iv),U(n.tag));default:throw new s('unsupported or invalid "alg" (JWE Algorithm) header value')}}(d,t,h,a)}catch(e){if(e instanceof TypeError)throw e;y=he(u)}const f=U(e.iv),g=U(e.tag),_=m.encode(null!==(n=e.protected)&&void 0!==n?n:"");let b;b=void 0!==e.aad?v(_,m.encode("."),m.encode(e.aad)):_;let A=await M(u,y,U(e.ciphertext),f,g,b);"DEF"===a.zip&&(A=await((null==r?void 0:r.inflateRaw)||J)(A));const I={plaintext:A};return void 0!==e.protected&&(I.protectedHeader=i),void 0!==e.aad&&(I.additionalAuthenticatedData=U(e.aad)),void 0!==e.unprotected&&(I.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(I.unprotectedHeader=e.header),I}async function Se(e,t,r){if(e instanceof Uint8Array&&(e=E.decode(e)),"string"!=typeof e)throw new c("Compact JWE must be a string or Uint8Array");const{0:n,1:i,2:o,3:s,4:a,length:d}=e.split(".");if(5!==d)throw new c("Invalid Compact JWE");const u=await we({ciphertext:s||void 0,iv:o||void 0,protected:n||void 0,tag:a||void 0,encrypted_key:i||void 0},t,r);return{plaintext:u.plaintext,protectedHeader:u.protectedHeader}}async function me(e){return(async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:R(e)};if(!N(e))throw new TypeError(D(e,"CryptoKey","Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:r,alg:n,use:i,...o}=await K.subtle.exportKey("jwk",e);return o})(e)}const Ee=oe(q);const _e=H(q),ve=le.bind(void 0,c,new Map);class be{constructor(e){this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new c("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!w(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new c("JWE Shared Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(ve(null==t?void 0:t.crit,this._protectedHeader,r),void 0!==r.zip){if(!this._protectedHeader||!this._protectedHeader.zip)throw new c('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==r.zip)throw new s('unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:n,enc:i}=r;if("string"!=typeof n||!n)throw new c('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof i||!i)throw new c('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let o,a,d,u,l,p,h;if("dir"===n){if(this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Encryption")}else if("ECDH-ES"===n&&this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Key Agreement");{let t;({cek:a,encryptedKey:o,parameters:t}=await async function(e,t,r,n,i={}){let o,a,c;switch(ce(e,r,"encrypt"),e){case"dir":c=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!z(r))throw new s("ECDH-ES with the provided key is not allowed or not supported by your javascript runtime");const{apu:d,apv:u}=i;let{epk:l}=i;l||(l=await(async e=>{if(!N(e))throw new TypeError(D(e,"CryptoKey"));return(await K.subtle.generateKey({name:"ECDH",namedCurve:e.algorithm.namedCurve},!0,["deriveBits"])).privateKey})(r));const{x:p,y:h,crv:y,kty:f}=await me(l),g=await V(r,l,"ECDH-ES"===e?t:e,parseInt(e.substr(-5,3),10)||ie.get(t),d,u);if(a={epk:{x:p,y:h,crv:y,kty:f}},d&&(a.apu=R(d)),u&&(a.apv=R(u)),"ECDH-ES"===e){c=g;break}c=n||Ee(t);const w=e.substr(-6);o=await L(w,g,c);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":c=n||Ee(t),o=await(async(e,t,r)=>{if(!N(t))throw new TypeError(D(t,"CryptoKey"));if(te(e,t),t.usages.includes("encrypt"))return new Uint8Array(await K.subtle.encrypt(ee(e),t,r));if(t.usages.includes("wrapKey")){const n=await K.subtle.importKey("raw",r,...F);return new Uint8Array(await K.subtle.wrapKey("raw",n,t,ee(e)))}throw new TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')})(e,r,c);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{c=n||Ee(t);const{p2c:s,p2s:d}=i;({encryptedKey:o,...a}=await Q(e,r,c,s,d));break}case"A128KW":case"A192KW":case"A256KW":c=n||Ee(t),o=await L(e,r,c);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{c=n||Ee(t);const{iv:s}=i;({encryptedKey:o,...a}=await(async(e,t,r,n)=>{const i=e.substr(0,7);n||(n=ne(i));const{ciphertext:o,tag:s}=await re(i,r,t,n,new Uint8Array(0));return{encryptedKey:o,iv:R(n),tag:R(s)}})(e,r,c,s));break}default:throw new s('unsupported or invalid "alg" (JWE Algorithm) header value')}return{cek:c,encryptedKey:o,parameters:a}}(n,i,e,this._cek,this._keyManagementParameters)),t&&(this._protectedHeader?this._protectedHeader={...this._protectedHeader,...t}:this.setProtectedHeader(t))}if(this._iv||(this._iv=_e(i)),u=this._protectedHeader?m.encode(R(JSON.stringify(this._protectedHeader))):m.encode(""),this._aad?(l=R(this._aad),d=v(u,m.encode("."),m.encode(l))):d=u,"DEF"===r.zip){const e=await((null==t?void 0:t.deflateRaw)||j)(this._plaintext);({ciphertext:p,tag:h}=await re(i,e,a,this._iv,d))}else({ciphertext:p,tag:h}=await re(i,this._plaintext,a,this._iv,d));const y={ciphertext:R(p),iv:R(this._iv),tag:R(h)};return o&&(y.encrypted_key=R(o)),l&&(y.aad=l),this._protectedHeader&&(y.protected=E.decode(u)),this._sharedUnprotectedHeader&&(y.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(y.header=this._unprotectedHeader),y}}class Ae{constructor(e){this._flattened=new be(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){const r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}async function Ie(e,t,r){if(!S(e))throw new c("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(S))throw new c("JWE Recipients missing or incorrect type");for(const n of e.recipients)try{return await we({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:n.encrypted_key,header:n.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch(e){}throw new a}async function Pe(e,t){const r={...e,...t.header};if(!S(r.jwk))throw new d('"jwk" (JSON Web Key) Header Parameter must be a JSON object');const n=await ae(r.jwk,r.alg,!0);if("public"!==n.type)throw new d('"jwk" (JSON Web Key) Header Parameter must be a public key');return n}const ke=(e,t)=>{if("string"!=typeof e||!e)throw new l(`${t} missing or invalid`)};async function Te(e,t="sha256"){if(!S(e))throw new TypeError("JWK must be an object");let r;switch(e.kty){case"EC":ke(e.crv,'"crv" (Curve) Parameter'),ke(e.x,'"x" (X Coordinate) Parameter'),ke(e.y,'"y" (Y Coordinate) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":ke(e.crv,'"crv" (Subtype of Key Pair) Parameter'),ke(e.x,'"x" (Public Key) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":ke(e.e,'"e" (Exponent) Parameter'),ke(e.n,'"n" (Modulus) Parameter'),r={e:e.e,kty:e.kty,n:e.n};break;case"oct":ke(e.k,'"k" (Key Value) Parameter'),r={k:e.k,kty:e.kty};break;default:throw new s('"kty" (Key Type) Parameter missing or unsupported')}const n=m.encode(JSON.stringify(r));return R(await B(t,n))}function Re(e){return S(e)}class Ue{constructor(e,t){if(this._cached=new WeakMap,!(e instanceof URL))throw new TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:null==t?void 0:t.agent},this._timeoutDuration="number"==typeof(null==t?void 0:t.timeoutDuration)?null==t?void 0:t.timeoutDuration:5e3,this._cooldownDuration="number"==typeof(null==t?void 0:t.cooldownDuration)?null==t?void 0:t.cooldownDuration:3e4}coolingDown(){return void 0!==this._cooldownStarted&&Date.now()<this._cooldownStarted+this._cooldownDuration}async getKey(e){this._jwks||await this.reload();const t=this._jwks.keys.filter((t=>{let r=t.kty===function(e){switch(e.substr(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new s('Unsupported "alg" value for a JSON Web Key Set')}}(e.alg);if(r&&"string"==typeof e.kid&&(r=e.kid===t.kid),r&&"string"==typeof t.alg&&(r=e.alg===t.alg),r&&"string"==typeof t.use&&(r="sig"===t.use),r&&Array.isArray(t.key_ops)&&(r=t.key_ops.includes("verify")),r&&"EdDSA"===e.alg&&(r=["Ed25519","Ed448"].includes(t.crv)),r)switch(e.alg){case"ES256":r="P-256"===t.crv;break;case"ES256K":r="secp256k1"===t.crv;break;case"ES384":r="P-384"===t.crv;break;case"ES512":r="P-521"===t.crv}return r})),{0:r,length:n}=t;if(0===n){if(!1===this.coolingDown())return await this.reload(),this.getKey(e);throw new h}if(1!==n)throw new y;this._cached.has(r)||this._cached.set(r,{});const i=this._cached.get(r);if(void 0===i[e.alg]){const t=await ae({...r,alg:e.alg});if("public"!==t.type)throw new p("JSON Web Key Set members must be public keys");i[e.alg]=t}return i[e.alg]}async reload(){this._pendingFetch||(this._pendingFetch=(async(e,t)=>{let r;"function"==typeof AbortController&&(r=new AbortController,setTimeout((()=>r.abort()),t));const i=await T.fetch(e.href,{signal:r?r.signal:void 0,redirect:"manual",referrerPolicy:"no-referrer",credentials:"omit",mode:"cors",method:"GET"});if(200!==i.status)throw new n("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await i.json()}catch(e){throw new n("Failed to parse the JSON Web Key Set HTTP response as JSON")}})(this._url,this._timeoutDuration,this._options).then((e=>{if("object"!=typeof e||!e||!Array.isArray(e.keys)||!e.keys.every(Re))throw new p("JSON Web Key Set malformed");this._jwks={keys:e.keys},this._cooldownStarted=Date.now(),this._pendingFetch=void 0})).catch((e=>{throw this._pendingFetch=void 0,e}))),await this._pendingFetch}}function Ce(e,t){const r=new Ue(e,t);return r.getKey.bind(r)}function He(e){switch(e){case"HS256":return{hash:{name:"SHA-256"},name:"HMAC"};case"HS384":return{hash:{name:"SHA-384"},name:"HMAC"};case"HS512":return{hash:{name:"SHA-512"},name:"HMAC"};case"PS256":return{hash:{name:"SHA-256"},name:"RSA-PSS",saltLength:32};case"PS384":return{hash:{name:"SHA-384"},name:"RSA-PSS",saltLength:48};case"PS512":return{hash:{name:"SHA-512"},name:"RSA-PSS",saltLength:64};case"RS256":return{hash:{name:"SHA-256"},name:"RSASSA-PKCS1-v1_5"};case"RS384":return{hash:{name:"SHA-384"},name:"RSASSA-PKCS1-v1_5"};case"RS512":return{hash:{name:"SHA-512"},name:"RSASSA-PKCS1-v1_5"};case"ES256":return{hash:{name:"SHA-256"},name:"ECDSA",namedCurve:"P-256"};case"ES384":return{hash:{name:"SHA-384"},name:"ECDSA",namedCurve:"P-384"};case"ES512":return{hash:{name:"SHA-512"},name:"ECDSA",namedCurve:"P-521"};default:throw new s(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}function Oe(e,t,r){if(N(t))return t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(D(t,"CryptoKey"));return K.subtle.importKey("raw",t,{hash:{name:`SHA-${e.substr(-3)}`},name:"HMAC"},!1,[r])}throw new TypeError(D(t,"CryptoKey","Uint8Array"))}const Ke=le.bind(void 0,d,new Map([["b64",!0]]));class Ne{constructor(e){this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new d("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!w(this._protectedHeader,this._unprotectedHeader))throw new d("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader};let n=!0;if(Ke(null==t?void 0:t.crit,this._protectedHeader,r).has("b64")&&(n=this._protectedHeader.b64,"boolean"!=typeof n))throw new d('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:i}=r;if("string"!=typeof i||!i)throw new d('JWS "alg" (Algorithm) Header Parameter missing or invalid');ce(i,e,"sign");let o,s=this._payload;n&&(s=m.encode(R(s))),o=this._protectedHeader?m.encode(R(JSON.stringify(this._protectedHeader))):m.encode("");const a=v(o,m.encode("."),s),c=await(async(e,t,r)=>{const n=await Oe(e,t,"sign");te(e,n);const i=await K.subtle.sign(He(e),n,r);return new Uint8Array(i)})(i,e,a),u={signature:R(c),payload:""};return n&&(u.payload=E.decode(s)),this._unprotectedHeader&&(u.header=this._unprotectedHeader),this._protectedHeader&&(u.protected=E.decode(o)),u}}class We{constructor(e){this._flattened=new Ne(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const r=await this._flattened.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}const De=le.bind(void 0,d,new Map([["b64",!0]])),Me=pe.bind(void 0,"algorithms");async function Je(e,t,r){var n;if(!S(e))throw new d("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new d('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new d("JWS Protected Header incorrect type");if(void 0===e.payload)throw new d("JWS Payload missing");if("string"!=typeof e.signature)throw new d("JWS Signature missing or incorrect type");if(void 0!==e.header&&!S(e.header))throw new d("JWS Unprotected Header incorrect type");let i={};if(e.protected){const t=U(e.protected);try{i=JSON.parse(E.decode(t))}catch(e){throw new d("JWS Protected Header is invalid")}}if(!w(i,e.header))throw new d("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const s={...i,...e.header};let a=!0;if(De(null==r?void 0:r.crit,i,s).has("b64")&&(a=i.b64,"boolean"!=typeof a))throw new d('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:c}=s;if("string"!=typeof c||!c)throw new d('JWS "alg" (Algorithm) Header Parameter missing or invalid');const u=r&&Me(r.algorithms);if(u&&!u.has(c))throw new o('"alg" (Algorithm) Header Parameter not allowed');if(a){if("string"!=typeof e.payload)throw new d("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new d("JWS Payload must be a string or an Uint8Array instance");"function"==typeof t&&(t=await t(i,e)),ce(c,t,"verify");const l=v(m.encode(null!==(n=e.protected)&&void 0!==n?n:""),m.encode("."),"string"==typeof e.payload?m.encode(e.payload):e.payload),p=U(e.signature);if(!await(async(e,t,r,n)=>{const i=await Oe(e,t,"verify");te(e,i);const o=He(e);try{return await K.subtle.verify(o,i,r,n)}catch(e){return!1}})(c,t,p,l))throw new f;let h;h=a?U(e.payload):"string"==typeof e.payload?m.encode(e.payload):e.payload;const y={payload:h};return void 0!==e.protected&&(y.protectedHeader=i),void 0!==e.header&&(y.unprotectedHeader=e.header),y}async function je(e,t,r){if(e instanceof Uint8Array&&(e=E.decode(e)),"string"!=typeof e)throw new d("Compact JWS must be a string or Uint8Array");const{0:n,1:i,2:o,length:s}=e.split(".");if(3!==s)throw new d("Invalid Compact JWS");const a=await Je({payload:i||void 0,protected:n||void 0,signature:o||void 0},t,r);return{payload:a.payload,protectedHeader:a.protectedHeader}}const Fe=new WeakMap;class xe{setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}set _protectedHeader(e){Fe.get(this).protectedHeader=e}get _protectedHeader(){return Fe.get(this).protectedHeader}set _unprotectedHeader(e){Fe.get(this).unprotectedHeader=e}get _unprotectedHeader(){return Fe.get(this).unprotectedHeader}}class $e{constructor(e){this._signatures=[],this._payload=e}addSignature(e,t){const r=new xe;return Fe.set(r,{key:e,options:t}),this._signatures.push(r),r}async sign(){if(!this._signatures.length)throw new d("at least one signature must be added");const e={signatures:[],payload:""};let t=new Set;if(await Promise.all(this._signatures.map((async r=>{const{protectedHeader:n,unprotectedHeader:i,options:o,key:s}=Fe.get(r),a=new Ne(this._payload);n&&a.setProtectedHeader(n),i&&a.setUnprotectedHeader(i);const{payload:c,...d}=await a.sign(s,o);t.add(c),e.payload=c,e.signatures.push(d)}))),1!==t.size)throw new d("inconsistent use of JWS Unencoded Payload Option (RFC7797)");return e}}async function Le(e,t,r){if(!S(e))throw new d("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(S))throw new d("JWS Signatures missing or incorrect type");for(const n of e.signatures)try{return await Je({header:n.header,payload:e.payload,protected:n.protected,signature:n.signature},t,r)}catch(e){}throw new f}var Ge=e=>Math.floor(e.getTime()/1e3);const Be=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;var Ve=e=>{const t=Be.exec(e);if(!t)throw new TypeError("Invalid time period format");const r=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(60*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(3600*r);case"day":case"days":case"d":return Math.round(86400*r);case"week":case"weeks":case"w":return Math.round(604800*r);default:return Math.round(31557600*r)}};const ze=e=>e.toLowerCase().replace(/^application\//,"");var qe=(e,t,r={})=>{const{typ:n}=r;if(n&&("string"!=typeof e.typ||ze(e.typ)!==ze(n)))throw new i('unexpected "typ" JWT header value',"typ","check_failed");let o;try{o=JSON.parse(E.decode(t))}catch(e){}if(!S(o))throw new u("JWT Claims Set must be a top-level JSON object");const{issuer:s}=r;if(s&&!(Array.isArray(s)?s:[s]).includes(o.iss))throw new i('unexpected "iss" claim value',"iss","check_failed");const{subject:a}=r;if(a&&o.sub!==a)throw new i('unexpected "sub" claim value',"sub","check_failed");const{audience:c}=r;if(c&&(l="string"==typeof c?[c]:c,!("string"==typeof(d=o.aud)?l.includes(d):Array.isArray(d)&&l.some(Set.prototype.has.bind(new Set(d))))))throw new i('unexpected "aud" claim value',"aud","check_failed");var d,l;let p;switch(typeof r.clockTolerance){case"string":p=Ve(r.clockTolerance);break;case"number":p=r.clockTolerance;break;case"undefined":p=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:h}=r,y=Ge(h||new Date);if(void 0!==o.iat||r.maxTokenAge){if("number"!=typeof o.iat)throw new i('"iat" claim must be a number',"iat","invalid");if(void 0===o.exp&&o.iat>y+p)throw new i('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}if(void 0!==o.nbf){if("number"!=typeof o.nbf)throw new i('"nbf" claim must be a number',"nbf","invalid");if(o.nbf>y+p)throw new i('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==o.exp){if("number"!=typeof o.exp)throw new i('"exp" claim must be a number',"exp","invalid");if(o.exp<=y-p)throw new g('"exp" claim timestamp check failed',"exp","check_failed")}if(r.maxTokenAge){const e=y-o.iat;if(e-p>("number"==typeof r.maxTokenAge?r.maxTokenAge:Ve(r.maxTokenAge)))throw new g('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-p)throw new i('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return o};async function Xe(e,t,r){const n=await Se(e,t,r),o=qe(n.protectedHeader,n.plaintext,r),{protectedHeader:s}=n;if(void 0!==s.iss&&s.iss!==o.iss)throw new i('replicated "iss" claim header parameter mismatch',"iss","mismatch");if(void 0!==s.sub&&s.sub!==o.sub)throw new i('replicated "sub" claim header parameter mismatch',"sub","mismatch");if(void 0!==s.aud&&JSON.stringify(s.aud)!==JSON.stringify(o.aud))throw new i('replicated "aud" claim header parameter mismatch',"aud","mismatch");return{payload:o,protectedHeader:s}}class Ye{constructor(e){if(!S(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return this._payload="number"==typeof e?{...this._payload,nbf:e}:{...this._payload,nbf:Ge(new Date)+Ve(e)},this}setExpirationTime(e){return this._payload="number"==typeof e?{...this._payload,exp:e}:{...this._payload,exp:Ge(new Date)+Ve(e)},this}setIssuedAt(e){return this._payload=void 0===e?{...this._payload,iat:Ge(new Date)}:{...this._payload,iat:e},this}}class Qe extends Ye{setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){const r=new Ae(m.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}class Ze extends Ye{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){var r;const n=new We(m.encode(JSON.stringify(this._payload)));if(n.setProtectedHeader(this._protectedHeader),Array.isArray(null===(r=this._protectedHeader)||void 0===r?void 0:r.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new u("JWTs MUST NOT use unencoded payload");return n.sign(e,t)}}class et extends Ye{encode(){return`${R(JSON.stringify({alg:"none"}))}.${R(JSON.stringify(this._payload))}.`}static decode(e,t){if("string"!=typeof e)throw new u("Unsecured JWT must be a string");const{0:r,1:n,2:i,length:o}=e.split(".");if(3!==o||""!==i)throw new u("Invalid Unsecured JWT");let s;try{if(s=JSON.parse(E.decode(U(r))),"none"!==s.alg)throw new Error}catch(e){throw new u("Invalid Unsecured JWT")}return{payload:qe(s,U(n),t),header:s}}}async function tt(e,t,r){var n;const i=await je(e,t,r);if((null===(n=i.protectedHeader.crit)||void 0===n?void 0:n.includes("b64"))&&!1===i.protectedHeader.b64)throw new u("JWTs MUST NOT use unencoded payload");return{payload:qe(i.protectedHeader,i.payload,r),protectedHeader:i.protectedHeader}}const rt=R,nt=U;function it(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(E.decode(nt(t)));if(!S(e))throw new Error;return e}catch(e){throw new TypeError("Invalid Token or Protected Header formatting")}}function ot(e){var t;const r=null!==(t=null==e?void 0:e.modulusLength)&&void 0!==t?t:2048;if("number"!=typeof r||r<2048)throw new s("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return r}async function st(e,t){return async function(e,t){var r,n;let i,o;switch(e){case"PS256":case"PS384":case"PS512":i={name:"RSA-PSS",hash:{name:`SHA-${e.substr(-3)}`},publicExponent:new Uint8Array([1,0,1]),modulusLength:ot(t)},o=["sign","verify"];break;case"RS256":case"RS384":case"RS512":i={name:"RSASSA-PKCS1-v1_5",hash:{name:`SHA-${e.substr(-3)}`},publicExponent:new Uint8Array([1,0,1]),modulusLength:ot(t)},o=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":i={name:"RSA-OAEP",hash:{name:`SHA-${parseInt(e.substr(-3),10)||1}`},publicExponent:new Uint8Array([1,0,1]),modulusLength:ot(t)},o=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":i={name:"ECDSA",namedCurve:"P-256"},o=["sign","verify"];break;case"ES384":i={name:"ECDSA",namedCurve:"P-384"},o=["sign","verify"];break;case"ES512":i={name:"ECDSA",namedCurve:"P-521"},o=["sign","verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":i={name:"ECDH",namedCurve:null!==(r=null==t?void 0:t.crv)&&void 0!==r?r:"P-256"},o=["deriveKey","deriveBits"];break;default:throw new s('unsupported or invalid JWK "alg" (Algorithm) Parameter value')}return K.subtle.generateKey(i,null!==(n=null==t?void 0:t.extractable)&&void 0!==n&&n,o)}(e,t)}async function at(e,t){return async function(e,t){var r;let n,i,o;switch(e){case"HS256":case"HS384":case"HS512":n=parseInt(e.substr(-3),10),i={name:"HMAC",hash:{name:`SHA-${n}`},length:n},o=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return n=parseInt(e.substr(-3),10),q(new Uint8Array(n>>3));case"A128KW":case"A192KW":case"A256KW":n=parseInt(e.substring(1,4),10),i={name:"AES-KW",length:n},o=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":n=parseInt(e.substring(1,4),10),i={name:"AES-GCM",length:n},o=["encrypt","decrypt"];break;default:throw new s('unsupported or invalid JWK "alg" (Algorithm) Parameter value')}return K.subtle.generateKey(i,null!==(r=null==t?void 0:t.extractable)&&void 0!==r&&r,o)}(e,t)}const ct=q},49112:(e,t,r)=>{"use strict";r.r(t),r.d(t,{CordovaIFrameNavigator:()=>n.CordovaIFrameNavigator,CordovaPopupNavigator:()=>n.CordovaPopupNavigator,InMemoryWebStorage:()=>n.InMemoryWebStorage,Log:()=>n.Log,OidcClient:()=>n.OidcClient,SessionMonitor:()=>n.SessionMonitor,User:()=>n.User,UserManager:()=>n.UserManager,Version:()=>n.Version,WebStorageStateStore:()=>n.WebStorageStateStore,clearOidcPersistentStorage:()=>h,getBearerToken:()=>d,getDpopToken:()=>u,refresh:()=>l,registerClient:()=>s,removeOidcQueryParam:()=>p});var n=r(64671),i=r(38736),o=r(24520);async function s(e,t){var r;if(!t.registrationEndpoint)throw new Error("Dynamic Registration could not be completed because the issuer has no registration endpoint.");if(!Array.isArray(t.idTokenSigningAlgValuesSupported))throw new Error("The OIDC issuer discovery profile is missing the 'id_token_signing_alg_values_supported' value, which is mandatory.");const n=(0,i.determineSigningAlg)(t.idTokenSigningAlgValuesSupported,i.PREFERRED_SIGNING_ALG),o={client_name:e.clientName,application_type:"web",redirect_uris:[null===(r=e.redirectUrl)||void 0===r?void 0:r.toString()],subject_type:"public",token_endpoint_auth_method:"client_secret_basic",id_token_signed_response_alg:n,grant_types:["authorization_code","refresh_token"]},s={"Content-Type":"application/json"};e.registrationAccessToken&&(s.Authorization=`Bearer ${e.registrationAccessToken}`);const a=await fetch(t.registrationEndpoint.toString(),{method:"POST",headers:s,body:JSON.stringify(o)});if(a.ok){const t=await a.json();return function(e,t){if(void 0===e.client_id)throw new Error(`Dynamic client registration failed: no client_id has been found on ${JSON.stringify(e)}`);if(t.redirectUrl&&(void 0===e.redirect_uris||e.redirect_uris[0]!==t.redirectUrl.toString()))throw new Error(`Dynamic client registration failed: the returned redirect URIs ${JSON.stringify(e.redirect_uris)} don't match the provided ${JSON.stringify([t.redirectUrl.toString()])}`)}(t,e),{clientId:t.client_id,clientSecret:t.client_secret,idTokenSignedResponseAlg:t.id_token_signed_response_alg,clientType:"dynamic"}}throw 400===a.status&&function(e,t){var r,n,i,o;if("invalid_redirect_uri"===e.error)throw new Error(`Dynamic client registration failed: the provided redirect uri [${null===(r=t.redirectUrl)||void 0===r?void 0:r.toString()}] is invalid - ${null!==(n=e.error_description)&&void 0!==n?n:""}`);if("invalid_client_metadata"===e.error)throw new Error(`Dynamic client registration failed: the provided client metadata ${JSON.stringify(t)} is invalid - ${null!==(i=e.error_description)&&void 0!==i?i:""}`);throw new Error(`Dynamic client registration failed: ${e.error} - ${null!==(o=e.error_description)&&void 0!==o?o:""}`)}(await a.json(),e),new Error(`Dynamic client registration failed: the server returned ${a.status} ${a.statusText} - ${await a.text()}`)}function a(e){return void 0!==e.error_description&&"string"==typeof e.error_description}function c(e,t){if(void 0!==(r=e).error&&"string"==typeof r.error)throw new i.OidcProviderError(`Token endpoint returned error [${e.error}]${a(e)?`: ${e.error_description}`:""}${function(e){return void 0!==e.error_uri&&"string"==typeof e.error_uri}(e)?` (see ${e.error_uri})`:""}`,e.error,a(e)?e.error_description:void 0);var r;if(!function(e){return void 0!==e.access_token&&"string"==typeof e.access_token}(e))throw new i.InvalidResponseError(["access_token"]);if(!function(e){return void 0!==e.id_token&&"string"==typeof e.id_token}(e))throw new i.InvalidResponseError(["id_token"]);if(!function(e){return void 0!==e.token_type&&"string"==typeof e.token_type}(e))throw new i.InvalidResponseError(["token_type"]);if(!function(e){return void 0===e.expires_in||"number"==typeof e.expires_in}(e))throw new i.InvalidResponseError(["expires_in"]);if(!t&&"bearer"!==e.token_type.toLowerCase())throw new Error(`Invalid token endpoint response: requested a [Bearer] token, but got a 'token_type' value of [${e.token_type}].`);return e}async function d(e){let t;try{const r=new n.OidcClient({response_mode:"query",loadUserInfo:!1});if(t=await r.processSigninResponse(e),void 0===r.settings.metadata)throw new Error("Cannot retrieve issuer metadata from client information in storage.");if(void 0===r.settings.metadata.jwks_uri)throw new Error("Missing some issuer metadata from client information in storage: 'jwks_uri' is undefined");if(void 0===r.settings.metadata.issuer)throw new Error("Missing some issuer metadata from client information in storage: 'issuer' is undefined");if(void 0===r.settings.client_id)throw new Error("Missing some client information in storage: 'client_id' is undefined");const o=await(0,i.getWebidFromTokenPayload)(t.id_token,r.settings.metadata.jwks_uri,r.settings.metadata.issuer,r.settings.client_id);return{accessToken:t.access_token,idToken:t.id_token,webId:o,refreshToken:t.refresh_token}}catch(t){throw new Error(`Problem handling Auth Code Grant (Flow) redirect - URL [${e}]: ${t}`)}}async function u(e,t,r){return async function(e,t,r,n){!function(e,t){if(t.grantType&&(!e.grantTypesSupported||!e.grantTypesSupported.includes(t.grantType)))throw new Error(`The issuer [${e.issuer}] does not support the [${t.grantType}] grant`);if(!e.tokenEndpoint)throw new Error(`This issuer [${e.issuer}] does not have a token endpoint`)}(e,r);const s={"content-type":"application/x-www-form-urlencoded"};let a;n&&(a=await(0,i.generateDpopKeyPair)(),s.DPoP=await(0,i.createDpopHeader)(e.tokenEndpoint,"POST",a)),t.clientSecret&&(s.Authorization=`Basic ${btoa(`${t.clientId}:${t.clientSecret}`)}`);const d={method:"POST",headers:s,body:(0,o.Z)({grant_type:r.grantType,redirect_uri:r.redirectUrl,code:r.code,code_verifier:r.codeVerifier,client_id:t.clientId})},u=await await fetch(e.tokenEndpoint,d),l=c(await u.json(),n),p=await(0,i.getWebidFromTokenPayload)(l.id_token,e.jwksUri,e.issuer,t.clientId);return{accessToken:l.access_token,idToken:l.id_token,refreshToken:(h=l,void 0!==h.refresh_token&&"string"==typeof h.refresh_token?l.refresh_token:void 0),webId:p,dpopKey:a,expiresIn:l.expires_in};var h}(e,t,r,!0)}async function l(e,t,r,n){const s={grant_type:"refresh_token",refresh_token:e,scope:"openid offline_access"};let a={};void 0!==n&&(a={DPoP:await(0,i.createDpopHeader)(t.tokenEndpoint,"POST",n)});let d={};void 0!==r.clientSecret&&(d={Authorization:`Basic ${btoa(`${r.clientId}:${r.clientSecret}`)}`});const u=await fetch(t.tokenEndpoint,{method:"POST",body:(0,o.Z)(s),headers:{...a,...d,"Content-Type":"application/x-www-form-urlencoded"}});let l;try{l=await u.json()}catch(e){throw new Error(`The token endpoint of issuer ${t.issuer} returned a malformed response.`)}const p=c(l,void 0!==n),h=await(0,i.getWebidFromTokenPayload)(p.id_token,t.jwksUri,t.issuer,r.clientId);return{accessToken:p.access_token,idToken:p.id_token,refreshToken:"string"==typeof p.refresh_token?p.refresh_token:void 0,webId:h,dpopKey:n,expiresIn:p.expires_in}}function p(e){const t=new URL(e);return t.searchParams.delete("code"),t.searchParams.delete("state"),t.hash="",t.toString()}async function h(){const e=new n.OidcClient({response_mode:"query"});await e.clearStaleState(new n.WebStorageStateStore({}));const t=window.localStorage,r=[];for(let e=0;e<=t.length;e+=1){const n=t.key(e);n&&(n.match(/^oidc\..+$/)||n.match(/^solidClientAuthenticationUser:.+$/))&&r.push(n)}r.forEach((e=>t.removeItem(e)))}},76572:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(38736),i=r(49112),o=r(88041),s=r(98700),a=(e,t)=>window.fetch(e,t);t.default=class{constructor(e,t,r,c,d){this.loginHandler=e,this.redirectHandler=t,this.logoutHandler=r,this.sessionInfoManager=c,this.issuerConfigFetcher=d,this.login=async(e,t)=>{var r,n;await this.sessionInfoManager.clear(e.sessionId);const o=i.removeOidcQueryParam(null!==(r=e.redirectUrl)&&void 0!==r?r:window.location.href);await this.loginHandler.handle({...e,redirectUrl:o,clientName:null!==(n=e.clientName)&&void 0!==n?n:e.clientId,eventEmitter:t})},this.fetch=a,this.logout=async e=>{await this.logoutHandler.handle(e),this.fetch=a},this.getSessionInfo=async e=>this.sessionInfoManager.get(e),this.getAllSessionInfo=async()=>this.sessionInfoManager.getAll(),this.validateCurrentSession=async()=>{const e=window.localStorage.getItem(s.KEY_CURRENT_SESSION);if(null===e)return null;const t=await this.sessionInfoManager.get(e);if(void 0===t||void 0===t.idToken||void 0===t.clientAppId||void 0===t.issuer)return null;const r=await this.issuerConfigFetcher.fetchConfig(t.issuer);try{const e=await n.fetchJwks(r.jwksUri,r.issuer);return await o.jwtVerify(t.idToken,await o.parseJwk(e),{audience:t.clientAppId,issuer:r.issuer}),t}catch(e){}return null},this.handleIncomingRedirect=async(e,t)=>{const r=await this.redirectHandler.handle(e,t);this.fetch=r.fetch.bind(window);const n=new URL(e);return n.searchParams.delete("state"),n.searchParams.delete("code"),n.searchParams.delete("id_token"),n.searchParams.delete("access_token"),n.searchParams.delete("error"),n.searchParams.delete("error_description"),window.history.replaceState(null,"",n.toString()),{isLoggedIn:r.isLoggedIn,webId:r.webId,sessionId:r.sessionId,expirationDate:r.expirationDate}}}}},74097:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Session=t.silentlyAuthenticate=void 0;const n=r(86874),i=r(38736),o=r(94740),s=r(99632),a=r(98700),c=r(63850);async function d(e,t,r={inIframe:!1},n){var i;const o=await t.validateCurrentSession();return null!==o&&(window.localStorage.setItem(a.KEY_CURRENT_URL,window.location.href),await t.login({sessionId:e,prompt:"none",oidcIssuer:o.issuer,redirectUrl:o.redirectUrl,clientId:o.clientAppId,clientSecret:o.clientAppSecret,tokenType:null!==(i=o.tokenType)&&void 0!==i?i:"DPoP",inIframe:r.inIframe},n),!0)}function u(e){return!!(null==e?void 0:e.isLoggedIn)}t.silentlyAuthenticate=d;class l extends n.EventEmitter{constructor(e={},t){super(),this.tokenRequestInProgress=!1,this.tmpFetchWithCookies=!1,this.login=async e=>{var t;return await this.clientAuthentication.login({sessionId:this.info.sessionId,...e,tokenType:null!==(t=e.tokenType)&&void 0!==t?t:"DPoP"},this),new Promise((()=>{}))},this.fetch=async(e,t)=>this.clientAuthentication.fetch(e,{...t,credentials:this.tmpFetchWithCookies?"include":null==t?void 0:t.credentials}),this.logout=async()=>{await this.clientAuthentication.logout(this.info.sessionId),this.info.isLoggedIn=!1,this.tmpFetchWithCookies=!1,this.emit("logout")},this.handleIncomingRedirect=async(e={})=>{var t;if(this.info.isLoggedIn)return this.info;if(this.tokenRequestInProgress)return;const r="string"==typeof e?{url:e}:e,n=null!==(t=r.url)&&void 0!==t?t:window.location.href;if(null!==window.frameElement)return void c.postRedirectUrlToParent(n);!0!==r.useEssSession||!0===r.restorePreviousSession?window.localStorage.setItem("tmp-resource-server-session-enabled","false"):window.localStorage.setItem("tmp-resource-server-session-enabled","true");const i=window.localStorage.getItem("tmp-resource-server-session-info");if("string"==typeof i&&!0!==r.restorePreviousSession&&!0===r.useEssSession){const e=JSON.parse(i);if(function(e){var t;const r=Object.keys(null!==(t=e.sessions)&&void 0!==t?t:{});return"string"==typeof e.webId&&r.length>0&&"number"==typeof e.sessions[r[0]].expiration}(e)){const t=Object.keys(e.sessions),r=new URL(e.webId).hostname,n=t.find((e=>new URL(e).hostname===r)),i=null!=n?n:t[0];if(e.sessions[i].expiration-Date.now()>3e5)return this.info.isLoggedIn=!0,this.info.webId=e.webId,this.tmpFetchWithCookies=!0,this.info}}this.tokenRequestInProgress=!0;const o=await this.clientAuthentication.handleIncomingRedirect(n,this);if(u(o)){this.setSessionInfo(o);const e=window.localStorage.getItem(a.KEY_CURRENT_URL);null===e?this.emit("login"):(window.localStorage.removeItem(a.KEY_CURRENT_URL),this.emit("sessionRestore",e))}else if(!0===r.restorePreviousSession){const e=window.localStorage.getItem(a.KEY_CURRENT_SESSION);if(null!==e&&await d(e,this.clientAuthentication,void 0,this))return new Promise((()=>{}))}return this.tokenRequestInProgress=!1,o},e.clientAuthentication?this.clientAuthentication=e.clientAuthentication:e.secureStorage&&e.insecureStorage?this.clientAuthentication=s.getClientAuthenticationWithDependencies({secureStorage:e.secureStorage,insecureStorage:e.insecureStorage}):this.clientAuthentication=s.getClientAuthenticationWithDependencies({}),e.sessionInfo?this.info={sessionId:e.sessionInfo.sessionId,isLoggedIn:!1,webId:e.sessionInfo.webId}:this.info={sessionId:null!=t?t:o.v4(),isLoggedIn:!1},c.setupIframeListener((async e=>{const t=await this.clientAuthentication.handleIncomingRedirect(e,this);u(t)&&this.setSessionInfo(t)})),this.on("tokenRenewal",(()=>d(this.info.sessionId,this.clientAuthentication,{inIframe:!0},this)))}onLogin(e){this.on("login",e)}onLogout(e){this.on("logout",e)}onError(e){this.on(i.EVENTS.ERROR,e)}onSessionRestore(e){this.on("sessionRestore",e)}onSessionExpiration(e){this.on(i.EVENTS.SESSION_EXPIRED,e)}setSessionInfo(e){this.info.isLoggedIn=e.isLoggedIn,this.info.webId=e.webId,this.info.sessionId=e.sessionId,this.info.expirationDate=e.expirationDate,this.on(i.EVENTS.SESSION_EXTENDED,(e=>{this.info.expirationDate=Date.now()+1e3*e}))}}t.Session=l},98700:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KEY_CURRENT_URL=t.KEY_CURRENT_SESSION=void 0;const n=r(38736);t.KEY_CURRENT_SESSION=`${n.SOLID_CLIENT_AUTHN_KEY_PREFIX}currentSession`,t.KEY_CURRENT_URL=`${n.SOLID_CLIENT_AUTHN_KEY_PREFIX}currentUrl`},91338:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onSessionRestore=t.onLogout=t.onLogin=t.handleIncomingRedirect=t.logout=t.login=t.fetch=t.getDefaultSession=void 0;const n=r(74097);let i;function o(){return void 0===i&&(i=new n.Session),i}t.getDefaultSession=o,t.fetch=(...e)=>o().fetch(...e),t.login=(...e)=>o().login(...e),t.logout=(...e)=>o().logout(...e),t.handleIncomingRedirect=(...e)=>o().handleIncomingRedirect(...e),t.onLogin=(...e)=>o().onLogin(...e),t.onLogout=(...e)=>o().onLogout(...e),t.onSessionRestore=(...e)=>o().onSessionRestore(...e)},99632:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getClientAuthenticationWithDependencies=void 0;const i=r(38736),o=n(r(63723)),s=n(r(76572)),a=n(r(38239)),c=n(r(47024)),d=n(r(61891)),u=r(49607),l=n(r(62345)),p=r(28214),h=r(78822),y=n(r(46894)),f=n(r(6686)),g=n(r(84575)),w=n(r(75866)),S=r(77912),m=n(r(99462));t.getClientAuthenticationWithDependencies=function(e){const t=new i.InMemoryStorage,r=e.secureStorage||t,n=e.insecureStorage||new f.default,E=new o.default(r,n),_=new d.default(E),v=new w.default(E),b=new p.SessionInfoManager(E),A=new m.default(E,_,v),I=new a.default(E,new c.default(E,new g.default),_,v),P=new y.default([new S.ErrorOidcHandler,new h.AuthCodeRedirectHandler(E,b,_,v,A),new u.FallbackRedirectHandler]);return new s.default(I,P,new l.default(b),b,_)}},63850:(e,t)=>{"use strict";let r;function n(){return void 0===r&&(r=window.document.createElement("iframe"),r.setAttribute("hidden","true"),r.setAttribute("sandbox","allow-scripts allow-same-origin")),r}Object.defineProperty(t,"__esModule",{value:!0}),t.postRedirectUrlToParent=t.setupIframeListener=t.redirectInIframe=void 0,t.redirectInIframe=function(e){const t=n();window.document.body.appendChild(t),t.src=e},t.setupIframeListener=function(e){"undefined"!=typeof window&&window.addEventListener("message",(async t=>{const r=n();t.origin===window.location.origin&&t.source===r.contentWindow&&"string"==typeof t.data.redirectUrl&&await e(t.data.redirectUrl),window.document.body.contains(r)&&window.document.body.removeChild(r)}))},t.postRedirectUrlToParent=function(e){window.top.postMessage({redirectUrl:e},window.location.origin)}},23612:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.InMemoryStorage=t.ConfigurationError=t.NotImplementedError=t.getClientAuthenticationWithDependencies=t.Session=void 0;var o=r(74097);Object.defineProperty(t,"Session",{enumerable:!0,get:function(){return o.Session}});var s=r(99632);Object.defineProperty(t,"getClientAuthenticationWithDependencies",{enumerable:!0,get:function(){return s.getClientAuthenticationWithDependencies}}),i(r(91338),t);var a=r(38736);Object.defineProperty(t,"NotImplementedError",{enumerable:!0,get:function(){return a.NotImplementedError}}),Object.defineProperty(t,"ConfigurationError",{enumerable:!0,get:function(){return a.ConfigurationError}}),Object.defineProperty(t,"InMemoryStorage",{enumerable:!0,get:function(){return a.InMemoryStorage}})},75866:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(49112);t.default=class{constructor(e){this.storageUtility=e}async getClient(e,t){var r;const[i,o]=await Promise.all([this.storageUtility.getForUser(e.sessionId,"clientId",{secure:!1}),this.storageUtility.getForUser(e.sessionId,"clientSecret",{secure:!1})]);if(i)return{clientId:i,clientSecret:o,clientType:"dynamic"};const s={...e};s.registrationAccessToken=null!==(r=s.registrationAccessToken)&&void 0!==r?r:await this.storageUtility.getForUser(e.sessionId,"registrationAccessToken");try{const e=await n.registerClient(s,t),r={clientId:e.clientId};return e.clientSecret&&(r.clientSecret=e.clientSecret),e.idTokenSignedResponseAlg&&(r.idTokenSignedResponseAlg=e.idTokenSignedResponseAlg),await this.storageUtility.setForUser(s.sessionId,r,{secure:!1}),e}catch(e){throw new Error(`Client registration failed: [${e.toString()}]`)}}}},61891:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WELL_KNOWN_OPENID_CONFIG=void 0;const n=r(38736),i=r(23685);t.WELL_KNOWN_OPENID_CONFIG=".well-known/openid-configuration";const o={issuer:{toKey:"issuer",convertToUrl:!0},authorization_endpoint:{toKey:"authorizationEndpoint",convertToUrl:!0},token_endpoint:{toKey:"tokenEndpoint",convertToUrl:!0},userinfo_endpoint:{toKey:"userinfoEndpoint",convertToUrl:!0},jwks_uri:{toKey:"jwksUri",convertToUrl:!0},registration_endpoint:{toKey:"registrationEndpoint",convertToUrl:!0},scopes_supported:{toKey:"scopesSupported"},response_types_supported:{toKey:"responseTypesSupported"},response_modes_supported:{toKey:"responseModesSupported"},grant_types_supported:{toKey:"grantTypesSupported"},acr_values_supported:{toKey:"acrValuesSupported"},subject_types_supported:{toKey:"subjectTypesSupported"},id_token_signing_alg_values_supported:{toKey:"idTokenSigningAlgValuesSupported"},id_token_encryption_alg_values_supported:{toKey:"idTokenEncryptionAlgValuesSupported"},id_token_encryption_enc_values_supported:{toKey:"idTokenEncryptionEncValuesSupported"},userinfo_signing_alg_values_supported:{toKey:"userinfoSigningAlgValuesSupported"},userinfo_encryption_alg_values_supported:{toKey:"userinfoEncryptionAlgValuesSupported"},userinfo_encryption_enc_values_supported:{toKey:"userinfoEncryptionEncValuesSupported"},request_object_signing_alg_values_supported:{toKey:"requestObjectSigningAlgValuesSupported"},request_object_encryption_alg_values_supported:{toKey:"requestObjectEncryptionAlgValuesSupported"},request_object_encryption_enc_values_supported:{toKey:"requestObjectEncryptionEncValuesSupported"},token_endpoint_auth_methods_supported:{toKey:"tokenEndpointAuthMethodsSupported"},token_endpoint_auth_signing_alg_values_supported:{toKey:"tokenEndpointAuthSigningAlgValuesSupported"},display_values_supported:{toKey:"displayValuesSupported"},claim_types_supported:{toKey:"claimTypesSupported"},claims_supported:{toKey:"claimsSupported"},service_documentation:{toKey:"serviceDocumentation"},claims_locales_supported:{toKey:"claimsLocalesSupported"},ui_locales_supported:{toKey:"uiLocalesSupported"},claims_parameter_supported:{toKey:"claimsParameterSupported"},request_parameter_supported:{toKey:"requestParameterSupported"},request_uri_parameter_supported:{toKey:"requestUriParameterSupported"},require_request_uri_registration:{toKey:"requireRequestUriRegistration"},op_policy_uri:{toKey:"opPolicyUri",convertToUrl:!0},op_tos_uri:{toKey:"opTosUri",convertToUrl:!0},solid_oidc_supported:{toKey:"solidOidcSupported"}};class s{constructor(e){this.storageUtility=e}static getLocalStorageKey(e){return`issuerConfig:${e}`}async fetchConfig(e){let r;const a=i.appendToUrlPathname(e,t.WELL_KNOWN_OPENID_CONFIG),c=await window.fetch(a);try{r=function(e){const t={};return Object.keys(e).forEach((r=>{o[r]&&(t[o[r].toKey]=e[r])})),t}(await c.json())}catch(t){throw new n.ConfigurationError(`[${e.toString()}] has an invalid configuration: ${t.message}`)}return await this.storageUtility.set(s.getLocalStorageKey(e),JSON.stringify(r)),r}}t.default=s},38239:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(38736);function i(e){return"string"==typeof e.oidcIssuer}function o(e){return"string"==typeof e.redirectUrl}t.default=class{constructor(e,t,r,n){this.storageUtility=e,this.oidcHandler=t,this.issuerConfigFetcher=r,this.clientRegistrar=n}async canHandle(e){return i(e)&&o(e)}async handle(e){if(!i(e))throw new n.ConfigurationError(`OidcLoginHandler requires an OIDC issuer: missing property 'oidcIssuer' in ${JSON.stringify(e)}`);if(!o(e))throw new n.ConfigurationError(`OidcLoginHandler requires a redirect URL: missing property 'redirectUrl' in ${JSON.stringify(e)}`);const t=await this.issuerConfigFetcher.fetchConfig(e.oidcIssuer),r=await n.handleRegistration(e,t,this.storageUtility,this.clientRegistrar),s={issuer:t.issuer,dpop:"dpop"===e.tokenType.toLowerCase(),...e,issuerConfiguration:t,client:r};return this.oidcHandler.handle(s)}}},84575:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(63850);t.default=class{redirect(e,t){t&&t.handleRedirect?t.handleRedirect(e):t&&t.redirectByReplacingState?window.history.replaceState({},"",e):(null==t?void 0:t.redirectInIframe)?n.redirectInIframe(e):window.location.href=e}}},47024:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(49112);t.default=class{constructor(e,t){this.storageUtility=e,this.redirector=t}async canHandle(e){return!!(e.issuerConfiguration.grantTypesSupported&&e.issuerConfiguration.grantTypesSupported.indexOf("authorization_code")>-1)}async handle(e){var t;const r={authority:e.issuer.toString(),client_id:e.client.clientId,client_secret:e.client.clientSecret,redirect_uri:e.redirectUrl.toString(),post_logout_redirect_uri:e.redirectUrl.toString(),response_type:"code",scope:"openid offline_access",filterProtocolClaims:!0,loadUserInfo:!1,code_verifier:!0,prompt:null!==(t=e.prompt)&&void 0!==t?t:"consent"},i=new n.OidcClient(r),{redirector:o}=this,s=this.storageUtility;try{const t=await i.createSigninRequest();await Promise.all([s.setForUser(t.state._id,{sessionId:e.sessionId}),s.setForUser(e.sessionId,{codeVerifier:t.state._code_verifier,issuer:e.issuer.toString(),redirectUrl:e.redirectUrl,dpop:e.dpop?"true":"false"})]),o.redirect(t.url.toString(),{handleRedirect:e.handleRedirect,redirectInIframe:e.inIframe})}catch(e){console.error(e)}}}},46894:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(38736);class i extends n.AggregateHandler{constructor(e){super(e)}}t.default=i},78822:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AuthCodeRedirectHandler=t.DEFAULT_LIFESPAN=void 0;const n=r(38736),i=r(49112),o=r(98700);t.DEFAULT_LIFESPAN=18e5,t.AuthCodeRedirectHandler=class{constructor(e,t,r,n,i){this.storageUtility=e,this.sessionInfoManager=t,this.issuerConfigFetcher=r,this.clientRegistrar=n,this.tokerRefresher=i}async canHandle(e){try{const t=new URL(e);return null!==t.searchParams.get("code")&&null!==t.searchParams.get("state")}catch(t){throw new Error(`[${e}] is not a valid URL, and cannot be used as a redirect URL: ${t.toString()}`)}}async handle(e,r){if(!await this.canHandle(e))throw new Error(`AuthCodeRedirectHandler cannot handle [${e}]: it is missing one of [code, state].`);const s=new URL(e),a=s.searchParams.get("state"),c=await this.storageUtility.getForUser(a,"sessionId",{errorIfNull:!0}),d="true"===await this.storageUtility.getForUser(c,"dpop"),u=await this.storageUtility.getForUser(c,"issuer",{errorIfNull:!0});window.localStorage.setItem(o.KEY_CURRENT_SESSION,c);const l=await this.issuerConfigFetcher.fetchConfig(u),p=await this.clientRegistrar.getClient({sessionId:c},l);let h;const y=Date.now();if(d){const e=await this.storageUtility.getForUser(c,"codeVerifier",{errorIfNull:!0}),t=await this.storageUtility.getForUser(c,"redirectUrl",{errorIfNull:!0});h=await i.getDpopToken(l,p,{grantType:"authorization_code",code:s.searchParams.get("code"),codeVerifier:e,redirectUrl:t})}else h=await i.getBearerToken(s.toString());let f;void 0!==h.refreshToken&&(f={sessionId:c,refreshToken:h.refreshToken,tokenRefresher:this.tokerRefresher});const g=await n.buildAuthenticatedFetch(fetch,h.accessToken,{dpopKey:h.dpopKey,refreshOptions:f,eventEmitter:r,expiresIn:h.expiresIn});await this.storageUtility.setForUser(c,{refreshToken:"<Refresh token that *is* coming back in the redirect URL is not yet being parsed and provided by oidc-client-js in it's response object>",webId:h.webId,isLoggedIn:"true"},{secure:!0}),s.searchParams.delete("code"),await this.storageUtility.setForUser(c,{redirectUrl:s.toString(),idToken:h.idToken},{secure:!1}),"false"===window.localStorage.getItem("tmp-resource-server-session-enabled")||await async function(e,r,n){const i=new URL(e).origin;await r(e);try{if(200===(await r(`${i}/session`)).status)return void await n.storeResourceServerSessionInfo(e,i,Date.now()+t.DEFAULT_LIFESPAN);await n.clearResourceServerSessionInfo(i)}catch(e){await n.clearResourceServerSessionInfo(i)}}(h.webId,g,this.storageUtility);const w=await this.sessionInfoManager.get(c);if(!w)throw new Error(`Could not retrieve session: [${c}].`);return Object.assign(w,{fetch:g,expirationDate:"number"==typeof h.expiresIn?y+1e3*h.expiresIn:null})}}},77912:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorOidcHandler=void 0;const n=r(38736),i=r(28214);t.ErrorOidcHandler=class{async canHandle(e){try{return new URL(e).searchParams.has("error")}catch(t){throw new Error(`[${e}] is not a valid URL, and cannot be used as a redirect URL: ${t.toString()}`)}}async handle(e,t){if(void 0!==t){const r=new URL(e),i=r.searchParams.get("error"),o=r.searchParams.get("error_description");t.emit(n.EVENTS.ERROR,i,o)}return i.getUnauthenticatedSession()}}},49607:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FallbackRedirectHandler=void 0;const n=r(28214);t.FallbackRedirectHandler=class{async canHandle(e){try{return new URL(e),!0}catch(t){throw new Error(`[${e}] is not a valid URL, and cannot be used as a redirect URL: ${t.toString()}`)}}async handle(e){return n.getUnauthenticatedSession()}}},99462:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(38736),i=r(49112);t.default=class{constructor(e,t,r){this.storageUtility=e,this.issuerConfigFetcher=t,this.clientRegistrar=r}async refresh(e,t,r,o){const s=await n.loadOidcContextFromStorage(e,this.storageUtility,this.issuerConfigFetcher),a=await this.clientRegistrar.getClient({sessionId:e},s.issuerConfig);if(void 0===t)throw new Error(`Session [${e}] has no refresh token to allow it to refresh its access token.`);if(s.dpop&&void 0===r)throw new Error(`For session [${e}], the key bound to the DPoP access token must be provided to refresh said access token.`);const c=await i.refresh(t,s.issuerConfig,a,r);return void 0!==c.refreshToken&&(null==o||o.emit(n.EVENTS.NEW_REFRESH_TOKEN,c.refreshToken),await this.storageUtility.setForUser(e,{refreshToken:c.refreshToken})),c}}},62345:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this.sessionInfoManager=e}async canHandle(){return!0}async handle(e){await this.sessionInfoManager.clear(e)}}},28214:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SessionInfoManager=t.clear=t.getUnauthenticatedSession=void 0;const n=r(38736),i=r(94740),o=r(49112);async function s(e,t){const r=await t.get("tmp-resource-server-session-info"),n=JSON.parse(null!=r?r:"{}"),{webId:i}=n;if(void 0!==i){const e=new URL(i).origin;await t.clearResourceServerSessionInfo(e)}await Promise.all([t.deleteAllUserData(e,{secure:!1}),t.deleteAllUserData(e,{secure:!0}),t.delete("clientKey",{secure:!1})]),await o.clearOidcPersistentStorage()}t.getUnauthenticatedSession=function(){return{isLoggedIn:!1,sessionId:i.v4(),fetch}},t.clear=s,t.SessionInfoManager=class{constructor(e){this.storageUtility=e}update(e,t){throw new Error("Not Implemented")}async get(e){var t;const r=await this.storageUtility.getForUser(e,"isLoggedIn",{secure:!0}),i=await this.storageUtility.getForUser(e,"webId",{secure:!0}),o=await this.storageUtility.getForUser(e,"clientId",{secure:!1}),s=await this.storageUtility.getForUser(e,"clientSecret",{secure:!1}),a=await this.storageUtility.getForUser(e,"idToken",{secure:!1}),c=await this.storageUtility.getForUser(e,"redirectUrl",{secure:!1}),d=await this.storageUtility.getForUser(e,"refreshToken",{secure:!0}),u=await this.storageUtility.getForUser(e,"issuer",{secure:!1}),l=null!==(t=await this.storageUtility.getForUser(e,"tokenType",{secure:!1}))&&void 0!==t?t:"DPoP";if(!n.isSupportedTokenType(l))throw new Error(`Tokens of type [${l}] are not supported.`);if(void 0!==o||void 0!==a||void 0!==r||void 0!==i||void 0!==d)return{sessionId:e,webId:i,isLoggedIn:"true"===r,redirectUrl:c,idToken:a,refreshToken:d,issuer:u,clientAppId:o,clientAppSecret:s,tokenType:l}}async getAll(){throw new Error("Not implemented")}async clear(e){return s(e,this.storageUtility)}async register(e){throw new Error("Not implemented")}async getRegisteredSessionIdAll(){throw new Error("Not implemented")}async clearAll(){throw new Error("Not implemented")}}},6686:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{get storage(){return window.localStorage}async get(e){return this.storage.getItem(e)||void 0}async set(e,t){this.storage.setItem(e,t)}async delete(e){this.storage.removeItem(e)}}},63723:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(38736);class i extends n.StorageUtility{constructor(e,t){super(e,t)}}t.default=i},23685:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appendToUrlPathname=void 0,t.appendToUrlPathname=function(e,t){const r=new URL(e),n=r.pathname;return r.pathname=`${n}${n.endsWith("/")?"":"/"}${t.startsWith("/")?t.substring(1):t}`,r.toString()}},58486:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateDpopKeyPair=t.createDpopHeader=void 0;const n=r(88041),i=r(94740),o=r(91039);function s(e){const t=new URL(e);return t.hash="",t.username="",t.password="",t.toString()}t.createDpopHeader=async function(e,t,r){return new n.SignJWT({htu:s(e),htm:t.toUpperCase(),jti:i.v4()}).setProtectedHeader({alg:o.PREFERRED_SIGNING_ALG[0],jwk:r.publicKey,typ:"dpop+jwt"}).setIssuedAt().sign(r.privateKey,{})},t.generateDpopKeyPair=async function(){const{privateKey:e,publicKey:t}=await n.generateKeyPair(o.PREFERRED_SIGNING_ALG[0]),r={privateKey:e,publicKey:await n.fromKeyLike(t)};return[r.publicKey.alg]=o.PREFERRED_SIGNING_ALG,r}},61936:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildAuthenticatedFetch=t.DEFAULT_EXPIRATION_TIME_SECONDS=void 0;const n=r(91039),i=r(58486),o=r(16557),s=r(37855);async function a(e,t,r,n,o){return e(r,await async function(e,t,r,n){return void 0!==r?async function(e,t,r,n){var o;const s={...n};return s.headers={...null==n?void 0:n.headers,Authorization:`DPoP ${t}`,DPoP:await i.createDpopHeader(e,null!==(o=null==n?void 0:n.method)&&void 0!==o?o:"get",r)},s}(e,t,r,n):{...n,headers:{...null==n?void 0:n.headers,Authorization:`Bearer ${t}`}}}(r.toString(),t,o,n))}t.DEFAULT_EXPIRATION_TIME_SECONDS=600;const c=e=>void 0!==e?e-n.REFRESH_BEFORE_EXPIRATION_SECONDS>0?e-n.REFRESH_BEFORE_EXPIRATION_SECONDS:e:t.DEFAULT_EXPIRATION_TIME_SECONDS;t.buildAuthenticatedFetch=async function(e,r,i){var d;let u,l=r;const p=null==i?void 0:i.refreshOptions;if(void 0!==p){const e=async()=>{var r,a,d,h;try{const{accessToken:o,refreshToken:s,expiresIn:a}=await async function(e,r,i){var o;const s=await e.tokenRefresher.refresh(e.sessionId,e.refreshToken,r);return null==i||i.emit(n.EVENTS.SESSION_EXTENDED,null!==(o=s.expiresIn)&&void 0!==o?o:t.DEFAULT_EXPIRATION_TIME_SECONDS),"string"==typeof s.refreshToken&&(null==i||i.emit(n.EVENTS.NEW_REFRESH_TOKEN,s.refreshToken)),{accessToken:s.accessToken,refreshToken:s.refreshToken,expiresIn:s.expiresIn}}(p,i.dpopKey,i.eventEmitter);l=o,void 0!==s&&(p.refreshToken=s),clearTimeout(u),u=setTimeout(e,1e3*c(a)),null===(r=i.eventEmitter)||void 0===r||r.emit(n.EVENTS.TIMEOUT_SET,u)}catch(e){e instanceof o.OidcProviderError&&(null===(a=null==i?void 0:i.eventEmitter)||void 0===a||a.emit(n.EVENTS.ERROR,e.error,e.errorDescription),null===(d=null==i?void 0:i.eventEmitter)||void 0===d||d.emit(n.EVENTS.SESSION_EXPIRED)),e instanceof s.InvalidResponseError&&e.missingFields.includes("access_token")&&(null===(h=null==i?void 0:i.eventEmitter)||void 0===h||h.emit(n.EVENTS.SESSION_EXPIRED))}};u=setTimeout(e,1e3*c(i.expiresIn)),null===(d=i.eventEmitter)||void 0===d||d.emit(n.EVENTS.TIMEOUT_SET,u)}else if(void 0!==i&&void 0!==i.eventEmitter){const e=setTimeout((()=>{i.eventEmitter.emit(n.EVENTS.SESSION_EXPIRED)}),1e3*c(i.expiresIn));i.eventEmitter.emit(n.EVENTS.TIMEOUT_SET,e)}return async(t,r)=>{let n=await a(e,l,t,r,null==i?void 0:i.dpopKey);const o=!n.ok&&(s=n.status,![401,403].includes(s));var s;return n.ok||o||n.url!==t&&void 0!==(null==i?void 0:i.dpopKey)&&(n=await a(e,l,n.url,r,i.dpopKey)),n}}},91039:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFRESH_BEFORE_EXPIRATION_SECONDS=t.EVENTS=t.PREFERRED_SIGNING_ALG=t.SOLID_CLIENT_AUTHN_KEY_PREFIX=void 0,t.SOLID_CLIENT_AUTHN_KEY_PREFIX="solidClientAuthn:",t.PREFERRED_SIGNING_ALG=["ES256","RS256"],t.EVENTS={NEW_REFRESH_TOKEN:"newRefreshToken",ERROR:"onError",SESSION_EXPIRED:"sessionExpired",SESSION_EXTENDED:"sessionExtended",TIMEOUT_SET:"timeoutSet"},t.REFRESH_BEFORE_EXPIRATION_SECONDS=5},29942:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(e)}}t.default=r},80596:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e,t,n=!0){super("string"==typeof e?r.substituteParams(e,t):r.appendErrorIri(r.lookupErrorIri(e,t),e,n))}httpResponse(e,t=!0){return this.message=r.appendHttpResponseDetails(this.message,e,t),this.httpErrorResponse=e,this}hasHttpResponse(){return void 0!==this.httpErrorResponse}getHttpResponse(){return this.httpErrorResponse}getHttpStatusCode(){if(void 0===this.httpErrorResponse)throw new r("This InruptError was not provided with a HTTP response - so we can't get its HTTP Status Code.");return this.httpErrorResponse.status}getHttpStatusText(){if(void 0===this.httpErrorResponse)throw new r("This InruptError was not provided with a HTTP response - so we can't get its HTTP Status Text!");return this.httpErrorResponse.statusText}static determineIfVocabTerm(e){return void 0!==e.strict}static lookupErrorIri(e,t){if(r.determineIfVocabTerm(e)){const r=void 0===t?e.message:e.messageParams(...t);return void 0===r?`Looked up error message IRI [${e.value}], but found no message value.`:r}return`Error message looked up at: [${e.value}]${void 0===t?"":`, with params [${t.toString()}]`}`}static appendHttpResponseDetails(e,t,r){return r&&void 0!==t?`${e} HTTP details: status code [${t.status}], status text [${t.statusText}].`:e}static appendErrorIri(e,t,r){return r?`${e} Error IRI: [${t.value}].`:e}static substituteParams(e,t){let r=e;if(void 0!==t){const n=e.split("{{").length-1;if(n!==t.length)throw new Error(`Setting parameters on message [${e}], but it requires [${n}] params and we received [${t.length}].`);for(let e=0;e<t.length;e+=1){const n=`{{${e}}}`;r=r.replace(n,t[e])}}return r}}t.default=r},37855:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidResponseError=void 0;class r extends Error{constructor(e){super(`Invalid response from OIDC provider: missing fields ${e}`),this.missingFields=e}}t.InvalidResponseError=r},29297:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(`[${e}] is not implemented`)}}t.default=r},16557:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OidcProviderError=void 0;class r extends Error{constructor(e,t,r){super(e),this.error=t,this.errorDescription=r}}t.OidcProviderError=r},38736:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StorageUtilityGetResponse=t.StorageUtilityMock=t.mockStorageUtility=t.mockStorage=t.buildAuthenticatedFetch=t.generateDpopKeyPair=t.createDpopHeader=t.OidcProviderError=t.InvalidResponseError=t.NotImplementedError=t.ConfigurationError=t.InMemoryStorage=t.getSessionIdFromOauthState=t.saveSessionInfoToStorage=t.loadOidcContextFromStorage=t.StorageUtility=t.determineSigningAlg=t.handleRegistration=t.USER_SESSION_PREFIX=t.isSupportedTokenType=t.fetchJwks=t.getWebidFromTokenPayload=t.AggregateHandler=void 0,i(r(91039),t);var s=r(84617);Object.defineProperty(t,"AggregateHandler",{enumerable:!0,get:function(){return o(s).default}});var a=r(34524);Object.defineProperty(t,"getWebidFromTokenPayload",{enumerable:!0,get:function(){return a.getWebidFromTokenPayload}}),Object.defineProperty(t,"fetchJwks",{enumerable:!0,get:function(){return a.fetchJwks}});var c=r(53070);Object.defineProperty(t,"isSupportedTokenType",{enumerable:!0,get:function(){return c.isSupportedTokenType}});var d=r(35941);Object.defineProperty(t,"USER_SESSION_PREFIX",{enumerable:!0,get:function(){return d.USER_SESSION_PREFIX}});var u=r(68656);Object.defineProperty(t,"handleRegistration",{enumerable:!0,get:function(){return u.handleRegistration}}),Object.defineProperty(t,"determineSigningAlg",{enumerable:!0,get:function(){return u.determineSigningAlg}});var l=r(32546);Object.defineProperty(t,"StorageUtility",{enumerable:!0,get:function(){return o(l).default}}),Object.defineProperty(t,"loadOidcContextFromStorage",{enumerable:!0,get:function(){return l.loadOidcContextFromStorage}}),Object.defineProperty(t,"saveSessionInfoToStorage",{enumerable:!0,get:function(){return l.saveSessionInfoToStorage}}),Object.defineProperty(t,"getSessionIdFromOauthState",{enumerable:!0,get:function(){return l.getSessionIdFromOauthState}});var p=r(4640);Object.defineProperty(t,"InMemoryStorage",{enumerable:!0,get:function(){return o(p).default}});var h=r(29942);Object.defineProperty(t,"ConfigurationError",{enumerable:!0,get:function(){return o(h).default}});var y=r(29297);Object.defineProperty(t,"NotImplementedError",{enumerable:!0,get:function(){return o(y).default}});var f=r(37855);Object.defineProperty(t,"InvalidResponseError",{enumerable:!0,get:function(){return f.InvalidResponseError}});var g=r(16557);Object.defineProperty(t,"OidcProviderError",{enumerable:!0,get:function(){return g.OidcProviderError}});var w=r(58486);Object.defineProperty(t,"createDpopHeader",{enumerable:!0,get:function(){return w.createDpopHeader}}),Object.defineProperty(t,"generateDpopKeyPair",{enumerable:!0,get:function(){return w.generateDpopKeyPair}});var S=r(61936);Object.defineProperty(t,"buildAuthenticatedFetch",{enumerable:!0,get:function(){return S.buildAuthenticatedFetch}});var m=r(62409);Object.defineProperty(t,"mockStorage",{enumerable:!0,get:function(){return m.mockStorage}}),Object.defineProperty(t,"mockStorageUtility",{enumerable:!0,get:function(){return m.mockStorageUtility}}),Object.defineProperty(t,"StorageUtilityMock",{enumerable:!0,get:function(){return m.StorageUtilityMock}}),Object.defineProperty(t,"StorageUtilityGetResponse",{enumerable:!0,get:function(){return m.StorageUtilityGetResponse}})},68656:(e,t)=>{"use strict";function r(e){try{return new URL(e),!0}catch(e){return!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.handleRegistration=t.determineSigningAlg=void 0,t.determineSigningAlg=function(e,t){var r;return null!==(r=t.find((t=>e.includes(t))))&&void 0!==r?r:null},t.handleRegistration=async function(e,t,n,i){const o=function(e,t){return void 0===e.clientId||r(e.clientId)?"https://solidproject.org/TR/solid-oidc"===t.solidOidcSupported&&void 0!==e.clientId&&r(e.clientId)?"solid-oidc":"dynamic":"static"}(e,t);return"dynamic"===o?i.getClient({sessionId:e.sessionId,clientName:e.clientName,redirectUrl:e.redirectUrl},t):(await n.setForUser(e.sessionId,{clientId:e.clientId}),e.clientSecret&&await n.setForUser(e.sessionId,{clientSecret:e.clientSecret}),e.clientName&&await n.setForUser(e.sessionId,{clientName:e.clientName}),{clientId:e.clientId,clientSecret:e.clientSecret,clientName:e.clientName,clientType:o})}},34524:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getWebidFromTokenPayload=t.fetchJwks=void 0;const n=r(54098),i=r(88041);async function o(e,t){const r=await n.fetch(e);if(200!==r.status)throw new Error(`Could not fetch JWKS for [${t}] at [${e}]: ${r.status} ${r.statusText}`);let i;try{i=(await r.json()).keys[0]}catch(r){throw new Error(`Malformed JWKS for [${t}] at [${e}]: ${r.message}`)}return i}t.fetchJwks=o,t.getWebidFromTokenPayload=async function(e,t,r,n){const s=await o(t,r);let a;try{const{payload:t}=await i.jwtVerify(e,await i.parseJwk(s),{issuer:r,audience:n});a=t}catch(e){throw new Error(`ID token verification failed: ${e.stack}`)}if("string"==typeof a.webid)return a.webid;if("string"!=typeof a.sub)throw new Error(`The ID token ${JSON.stringify(a)} is invalid: it has no 'webid' claim and no 'sub' claim.`);try{return new URL(a.sub),a.sub}catch(e){throw new Error(`The ID token has no 'webid' claim, and its 'sub' claim of [${a.sub}] is invalid as a URL - error [${e}].`)}}},53070:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedTokenType=void 0,t.isSupportedTokenType=function(e){return"string"==typeof e&&["DPoP","Bearer"].includes(e)}},35941:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.USER_SESSION_PREFIX=void 0,t.USER_SESSION_PREFIX="solidClientAuthenticationUser"},4640:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.map={}}async get(e){return this.map[e]||void 0}async set(e,t){this.map[e]=t}async delete(e){delete this.map[e]}}},32546:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.saveSessionInfoToStorage=t.loadOidcContextFromStorage=t.getSessionIdFromOauthState=void 0;const i=r(88041),o=n(r(80596));t.getSessionIdFromOauthState=async function(e,t){return e.getForUser(t,"sessionId")},t.loadOidcContextFromStorage=async function(e,t,r){try{const[n,i,o,s]=await Promise.all([t.getForUser(e,"issuer",{errorIfNull:!0}),t.getForUser(e,"codeVerifier"),t.getForUser(e,"redirectUrl"),t.getForUser(e,"dpop",{errorIfNull:!0})]);return{codeVerifier:i,redirectUrl:o,issuerConfig:await r.fetchConfig(n),dpop:"true"===s}}catch(t){throw new Error(`Failed to retrieve OIDC context from storage associated with session [${e}]: ${t.toString()}`)}},t.saveSessionInfoToStorage=async function(e,t,r,n,o,s,a,c){void 0!==s&&await e.setForUser(t,{refreshToken:s},{secure:a}),void 0!==r&&await e.setForUser(t,{idToken:r},{secure:a}),void 0!==n&&await e.setForUser(t,{webId:n},{secure:a}),void 0!==o&&await e.setForUser(t,{isLoggedIn:o},{secure:a}),void 0!==c&&await e.setForUser(t,{publicKey:JSON.stringify(c.publicKey),privateKey:JSON.stringify(await i.fromKeyLike(c.privateKey))},{secure:a})},t.default=class{constructor(e,t){this.secureStorage=e,this.insecureStorage=t,this.RESOURCE_SERVER_SESSION_INFORMATION_KEY="tmp-resource-server-session-info"}getKey(e){return`solidClientAuthenticationUser:${e}`}async getUserData(e,t){const r=await(t?this.secureStorage:this.insecureStorage).get(this.getKey(e));if(void 0===r)return{};try{return JSON.parse(r)}catch(n){throw new o.default(`Data for user [${e}] in [${t?"secure":"unsecure"}] storage is corrupted - expected valid JSON, but got: ${r}`)}}async setUserData(e,t,r){await(r?this.secureStorage:this.insecureStorage).set(this.getKey(e),JSON.stringify(t))}async get(e,t){const r=await((null==t?void 0:t.secure)?this.secureStorage:this.insecureStorage).get(e);if(void 0===r&&(null==t?void 0:t.errorIfNull))throw new o.default(`[${e}] is not stored`);return r}async set(e,t,r){return((null==r?void 0:r.secure)?this.secureStorage:this.insecureStorage).set(e,t)}async delete(e,t){return((null==t?void 0:t.secure)?this.secureStorage:this.insecureStorage).delete(e)}async getForUser(e,t,r){const n=await this.getUserData(e,null==r?void 0:r.secure);let i;if(n&&n[t]||(i=void 0),i=n[t],void 0===i&&(null==r?void 0:r.errorIfNull))throw new o.default(`Field [${t}] for user [${e}] is not stored`);return i||void 0}async setForUser(e,t,r){let n;try{n=await this.getUserData(e,null==r?void 0:r.secure)}catch(e){n={}}await this.setUserData(e,{...n,...t},null==r?void 0:r.secure)}async deleteForUser(e,t,r){const n=await this.getUserData(e,null==r?void 0:r.secure);delete n[t],await this.setUserData(e,n,null==r?void 0:r.secure)}async deleteAllUserData(e,t){await((null==t?void 0:t.secure)?this.secureStorage:this.insecureStorage).delete(this.getKey(e))}async storeResourceServerSessionInfo(e,t,r){var n;const i=JSON.parse(null!==(n=await this.insecureStorage.get(this.RESOURCE_SERVER_SESSION_INFORMATION_KEY))&&void 0!==n?n:"{}");i.webId!==e&&(i.sessions={}),i.webId=e,i.sessions[t]={expiration:r},await this.insecureStorage.set(this.RESOURCE_SERVER_SESSION_INFORMATION_KEY,JSON.stringify(i))}async clearResourceServerSessionInfo(e){var t;const r=JSON.parse(null!==(t=await this.insecureStorage.get(this.RESOURCE_SERVER_SESSION_INFORMATION_KEY))&&void 0!==t?t:"{}");void 0!==r.sessions&&(delete r.sessions[e],0===Object.keys(r.sessions).length?await this.insecureStorage.set(this.RESOURCE_SERVER_SESSION_INFORMATION_KEY,"{}"):await this.insecureStorage.set(this.RESOURCE_SERVER_SESSION_INFORMATION_KEY,JSON.stringify(r)))}}},62409:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mockStorageUtility=t.mockStorage=t.StorageUtilityMock=t.StorageUtilityGetResponse=void 0;const n=r(38736);t.StorageUtilityGetResponse="getResponse",t.StorageUtilityMock={get:async(e,r)=>t.StorageUtilityGetResponse,set:async(e,t)=>{},delete:async e=>{},getForUser:async(e,r,n)=>t.StorageUtilityGetResponse,setForUser:async(e,t,r)=>{},deleteForUser:async(e,t,r)=>{},deleteAllUserData:async(e,t)=>{},storeResourceServerSessionInfo:async(e,t,r)=>{},clearResourceServerSessionInfo:async e=>{}},t.mockStorage=e=>{const t=e;return{get:async e=>{if(void 0!==t[e])return"string"==typeof t[e]?t[e]:JSON.stringify(t[e])},set:async(e,r)=>{t[e]=r},delete:async e=>{delete t[e]}}},t.mockStorageUtility=(e,r=!1)=>r?new n.StorageUtility(t.mockStorage(e),t.mockStorage({})):new n.StorageUtility(t.mockStorage({}),t.mockStorage(e))},84617:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(80596));t.default=class{constructor(e){this.handleables=e}async getProperHandler(e){const t=await Promise.all(this.handleables.map((t=>t.canHandle(...e))));for(let e=0;e<t.length;e+=1)if(t[e])return this.handleables[e];return null}async canHandle(...e){return null!==await this.getProperHandler(e)}async handle(...e){const t=await this.getProperHandler(e);if(t)return t.handle(...e);throw new i.default(`[${this.constructor.name}] cannot find a suitable handler for: ${e.map((e=>{try{return JSON.stringify(e)}catch(t){return e.toString()}})).join(", ")}`)}}}}]);